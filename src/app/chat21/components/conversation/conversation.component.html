
<!-- tabindex="1500"-->
<div id="chat21-conversation-component" 
#afConversationComponent
tabindex="1500" 
aria-modal="true"
onFocus="document.querySelector('[start-focus-chat21-conversation-component]').focus()">

    <!-- HEADER -->
    <div class="c21-header" [ngStyle]="{'background-color': g.themeColor}">

        <div class="c21-header-container">

            <!-- CONTENT HEADER -->
            <div class="c21-header-content">

                <!-- ICON CLOSE CHAT -->
                <button tabindex="-1" class="c21-header-button c21-right c21-close c21-button-clean" [ngStyle]="{'display': (g.hideHeaderCloseButton)?'none':'flex'}" (click)="returnCloseWidget()">
                    <svg role="img" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeForegroundColor }" xmlns="http://www.w3.org/2000/svg"
                        width="24px" height="24px" viewBox="0 0 24 24">
                        <path fill="none" d="M0 0h24v24H0V0z" />
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
                        <title id="altIconTitle">{{g.BUTTON_CLOSE_TO_ICON}}</title>
                    </svg>
                </button>

                <button tabindex="-1" class="c21-header-button c21-right c21-button-clean" (click)="toggleMenu()">
                    <svg aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeForegroundColor }" xmlns="http://www.w3.org/2000/svg"
                        width="24" height="24" viewBox="0 0 24 24">
                        <path fill="none" d="M0 0h24v24H0V0z" />
                        <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                        <title id="altIconTitle">{{g.OPTIONS}}</title>
                    </svg>
                </button>



                <!-- ICON BACK -->
                <button tabindex="1530" aria-label=" indietro " class="c21-header-button c21-left c21-button-clean" (click)="returnHome()">
                    <svg role="img" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeForegroundColor }" xmlns="http://www.w3.org/2000/svg"
                        width="24px" height="24px" viewBox="0 0 24 24">
                        <!-- <path fill="none" d="M0 0h24v24H0V0z"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM7.07 18.28c.43-.9 3.05-1.78 4.93-1.78s4.51.88 4.93 1.78C15.57 19.36 13.86 20 12 20s-3.57-.64-4.93-1.72zm11.29-1.45c-1.43-1.74-4.9-2.33-6.36-2.33s-4.93.59-6.36 2.33C4.62 15.49 4 13.82 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8c0 1.82-.62 3.49-1.64 4.83zM12 6c-1.94 0-3.5 1.56-3.5 3.5S10.06 13 12 13s3.5-1.56 3.5-3.5S13.94 6 12 6zm0 5c-.83 0-1.5-.67-1.5-1.5S11.17 8 12 8s1.5.67 1.5 1.5S12.83 11 12 11z"/> -->
                        <path fill="none" d="M0 0h24v24H0V0z" />
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59z" />
                        <title id="altIconTitle">{{g.PREV_CONVERSATIONS}}</title>
                    </svg>
                </button>

                <!-- TITLE HEADER -->
                <div class="c21-title" [ngStyle]="{'color': g.themeForegroundColor}">
                    <span>{{g.widgetTitle}}</span>
                    <span id="agent-available-status">{{g.areAgentsAvailableText}}</span>
                </div>
                <p class="c21-header-writing" [ngStyle]="{'color': g.themeForegroundColor}">{{writingMessage}}</p>

            </div>

        </div>

    </div>

    <!-- CONTENT -->
    <div class="c21-body" (click)="hideMenuOptions()">

        <div class="c21-body-container">

            <div class="c21-body-header">

                <!-- 
                    // nk new: simulates a higher header content -- USED ONLY FIRST MSG
                    ??? a cosa serve ??? 
                    -->
                <!-- <div *ngIf="isNewConversation == true && g.projectid != null" 
                        class="chat21-sheet-content-themable-section" 
                        [ngClass]="{'themable-section-agent_not_available':!areAgentsAvailable}" 
                        [ngStyle]="{'background-color': g.themeColor}">
                    </div> -->
                <!-- // AVATAR -->

                <!-- DISPLAYS THE MSG 'ALL AGENT ARE OFFLINE' IN THE VIEW WHEN THERE IS NOT DISPLAYS WHEN THE USER DIGIT THE FIRST MSG -->
                <!-- <div *ngIf="!areAgentsAvailable && isNewConversation && availableAgentsStatus && messages.length == 0" 
                        class="chat21-agents-available chat21-agents-available-is-new-conversation" 
                        [ngStyle]="{ 'border-top': '2.4px solid', 'border-top-color': themeColor50 }"
                        >
                        <span style="font-size:18px">ðŸ¤”</span>  
                        <span>{{ g.ALL_AGENTS_OFFLINE_LABEL }}</span>
                    </div> -->

                <!-- // nk - to edit: display the msg of welcome msg if exist && g.availableAgentsStatus -->
                <!-- <div *ngIf="isNewConversation && messages.length == 0" class="chat21-header-modal-select chat21-header-modal-select-first-msg"
                    [ngStyle]="{ 'border-top': '2.4px solid', 'border-top-color': themeColor50 }">
                    <div *ngIf="g.areAgentsAvailable">
                        <span> {{g.LABEL_FIRST_MSG}} </span>
                    </div>
                    <div *ngIf="!g.areAgentsAvailable">
                        <span>{{g.LABEL_FIRST_MSG_NO_AGENTS}}</span>
                    </div>
                </div> -->

                <!-- // nk - to edit: display the msg of welcome msg if exist -->
                <!-- <div *ngIf="isNewConversation && g.areAgentsAvailable && messages.length == 0" class="chat21-header-modal-select chat21-header-modal-select-more-of-one-dept">
                    {{g.departmentSelected.name}}
                </div> -->

            </div>

            <div class="c21-body-content" tabindex="1520" aria-label=" messaggi della conversazione: ">

                <!-- CONTENT -->
                <div [class.active]="!isNewConversation && messages && messages.length == 0" class="chat21-spinner" id="chat21-spinner">
                    <div class="chat21-bounce1"></div>
                    <div class="chat21-bounce2"></div>
                    <div class="chat21-bounce3"></div>
                    <span>loading</span>
                </div>

                <div id="chat21-sheet-content" class="chat21-sheet-content">
                    <div class="chat21-conversation-parts-container">
                        <div #scrollMe id="scroll-me" style="height:100%; overflow-y:auto;" (scroll)="onScroll($event)">

                            <div id="{{idDivScroll}}" class="c21-contentScroll" > <!-- (resized)="onResized($event)" -->
                                <div *ngFor="let message of messages" tabindex="1521" >
    
                                    <!-- message sender:: -->
                                    <div role="messaggio" *ngIf="message.sender == g.senderId;" class="msg_container base_sent" >

                                        <div class="messages msg_sent primary-color" [ngStyle]=styleSecondColor >

                                            <!-- message type:: image -->
                                            <img *ngIf="message.type == 'image' && message.metadata" class="message-contentX message-content-imageX"
                                                [src]="message.metadata.src" [width]="getSizeImg(message).width"
                                                [height]="getSizeImg(message).height" />

                                            <!-- message type:: text -->
                                            <div *ngIf="message.type == 'text'">
                                                <div *ngIf="isPopupUrl(message.text); then contentPopup else contentNewTab">here
                                                    is ignored</div>
                                                <ng-template #contentPopup>
                                                    <p style="text-decoration: underline; padding:8px; cursor: pointer;"
                                                        (click)="popupUrl(g.windowContext, message.text,'windowName')">{{strip_tags(message.text)}}</p>
                                                </ng-template>
                                                <ng-template #contentNewTab>
                                                    <p #messageEl [innerHTML]="printMessage(message, messageEl, this) | linky"></p>
                                                    <!-- <p [innerHTML]="message.text | linky"></p> -->
                                                </ng-template>
                                            </div>

                                        </div>

                                        <!-- icon status message -->
                                        <div class="status-message">
                                            <div *ngIf="!message.status" class="icon f21ico-schedule"></div>
                                            <div *ngIf="message.status == MSG_STATUS_SENT" class="icon c21-ico-done"></div>
                                            <div *ngIf="message.status == MSG_STATUS_SENT_SERVER" class="icon c21-ico-done"></div>
                                            <div *ngIf="message.status == MSG_STATUS_RETURN_RECEIPT" class="icon c21-ico-done_all"></div>
                                        </div>

                                    </div>


                                    <!-- message recipient:: -->
                                    <div role="messaggio" *ngIf="message.sender != g.senderId;" class="message_sender_fullname">{{message.sender_fullname}}</div>
                                    <div role="messaggio" *ngIf="message.sender != g.senderId;" class="msg_container base_receive">
        
                                        <!-- <div class="content-avatar">
                                            <div class="profile_image">
                                                <img src="{{getUrlImgProfile(message.sender)}}" />
                                            </div>
                                        </div> -->

                                        <div class="c21-icon-avatar">
                                            <div class="c21-avatar-image profile_image">
                                                <!-- <img src="{{getUrlImgProfile(message.sender)}}" onError="this.src = 'https://s3.eu-west-1.amazonaws.com/tiledesk-widget/v2/assets/images/line_avatar_male_tiledesk.svg'" /> -->
                                                <img src="{{getUrlImgProfile(message.sender)}}" onError="this.src = 'https://s3.eu-west-1.amazonaws.com/tiledesk-widget/dev/2.0.4-beta.7/assets/images/avatar_bot_tiledesk.svg'" />
                                            </div> 
                                        </div>


                                        <div class="messages msg_receive">
                                           
                                            <!-- <div>{{triggerBeforeMessageRender(message)}}</div> -->

                                            <!-- message type:: image -->
                                            <img *ngIf="message.type == 'image' && message.metadata" class="message-contentX message-content-imageX"
                                                [src]="message.metadata.src" [width]="getSizeImg(message).width"
                                                [height]="getSizeImg(message).height" />

                                            <!-- message type:: text -->
                                            <div *ngIf="message.type == 'text';">
                                               
                                                <div *ngIf="isPopupUrl(message.text); then contentPopup else contentNewTab">here
                                                    is ignored</div>

                                                <ng-template #contentPopup>
                                                    <p style="text-decoration: underline; padding:8px; cursor: pointer;"
                                                        (click)="popupUrl(g.windowContext, message.text,'windowName')">{{strip_tags(message.text)}}
                                                    </p>
                                                </ng-template>
                                                <ng-template #contentNewTab>


                                                    <!-- old -->
                                                    <!-- <p>{{printTrustedHtml(message.text)}}</p> -->
                                                    <!-- <div [innerHTML]="message.text | safeHtml"></div> -->

                                                    <p #messageEl [innerHTML]="printMessage(message, messageEl, this) | linky"></p>
                                                    <!-- <p [innerHTML]="message.uid | linky"></p> -->

                                                    <!-- <p [innerHTML]="videoUrl"></p> -->
                                                    
                                                    <!-- <p [innerHTML]="message.print() | linky"></p> -->
                                                    <!-- <p [innerHTML]="message.text | linky"></p> -->

                                                </ng-template>
                                            </div>

                                        </div>

                                    </div>


                                    <div class="time" [ngClass]="{'sender' : message.sender == g.senderId}">
                                        <time *ngIf="message.sender!=='' && message.timestamp !== '{.sv: timestamp}'" >{{message.timestamp  | amTimeAgo}} </time>
                                    </div>


                                    <!-- message type:: button -->
                                    <div *ngIf="message.attributes && message.attributes.attachment && isLastMessage(message.uid)"> 
                                        <tiledeskwidget-message-attachment 
                                        style="height: 50px; display: block"
                                        [message]="message"
                                        (eventOpenAttachment)="returnOpenAttachment($event)"
                                        >
                                        </tiledeskwidget-message-attachment>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="isMenuShow" id="c21-options-menu" [ngStyle]="{ 'border-top': '2.4px solid', 'border-top-color': themeColor50, 'color': g.themeColor }">
        <!-- ICON VOLUME -->
        <div class="c21-header-button c21-right" (click)="toggleSound()">
            <svg *ngIf="!g.isSoundActive" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeColor }" xmlns="http://www.w3.org/2000/svg"
                width="20" height="20" viewBox="0 0 24 24">
                <path fill="none" d="M0 0h24v24H0V0z" />
                <path d="M4.34 2.93L2.93 4.34 7.29 8.7 7 9H3v6h4l5 5v-6.59l4.18 4.18c-.65.49-1.38.88-2.18 1.11v2.06c1.34-.3 2.57-.92 3.61-1.75l2.05 2.05 1.41-1.41L4.34 2.93zM10 15.17L7.83 13H5v-2h2.83l.88-.88L10 11.41v3.76zM19 12c0 .82-.15 1.61-.41 2.34l1.53 1.53c.56-1.17.88-2.48.88-3.87 0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zm-7-8l-1.88 1.88L12 7.76zm4.5 8c0-1.77-1.02-3.29-2.5-4.03v1.79l2.48 2.48c.01-.08.02-.16.02-.24z" />
                <title id="altIconTitle">{{g.SOUND_OFF}}</title>
            </svg>
            <svg *ngIf="g.isSoundActive" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeColor }" xmlns="http://www.w3.org/2000/svg"
                width="20" height="20" viewBox="0 0 24 24">
                <path fill="none" d="M0 0h24v24H0V0z" />
                <path d="M3 9v6h4l5 5V4L7 9H3zm7-.17v6.34L7.83 13H5v-2h2.83L10 8.83zM16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77 0-4.28-2.99-7.86-7-8.77z" />
                <title id="altIconTitle">{{g.SOUND_ON}}</title>
            </svg>
            <span *ngIf="!g.isSoundActive" class="label-menu-item"> {{g.SOUND_OFF}}</span>
            <span *ngIf="g.isSoundActive" class="label-menu-item"> {{g.SOUND_ON}}</span>
        </div>

        <!-- ICON TRANSCRIPT -->
        <div class="c21-header-button c21-right" *ngIf="messages && messages.length > 1 && g.allowTranscriptDownload" (click)="dowloadTranscript()">
            <svg role="img" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeColor }" xmlns="http://www.w3.org/2000/svg"
                width="20px" height="20px" viewBox="0 0 24 24">
                <!-- <path fill="none" d="M0 0h24v24H0V0z"/><path d="M13 5v6h1.17L12 13.17 9.83 11H11V5h2m2-2H9v6H5l7 7 7-7h-4V3zm4 15H5v2h14v-2z"/> -->
                <path fill="none" d="M0 0h24v24H0V0z" />
                <path d="M16 13h-3V3h-2v10H8l4 4 4-4zM4 19v2h16v-2H4z" />
                <title id="altIconTitle">{{g.BUTTON_DOWNLOAD_TRANSCRIPT}}</title>
            </svg>
            <span class="label-menu-item">{{g.BUTTON_DOWNLOAD_TRANSCRIPT}}</span>
        </div>

        <!-- ICON EDIT PROFILE -->
        <!-- <div class="c21-header-button c21-right" *ngIf="messages && messages.length > 1">
            <svg role="img" aria-labelledby="altIconTitle" [ngStyle]="{'fill': g.themeForegroundColor }" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24">
                <path fill="none" d="M0 0h24v24H0V0z"/><path d="M12 6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0 10c2.7 0 5.8 1.29 6 2H6c.23-.72 3.31-2 6-2m0-12C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 10c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                <title id="altIconTitle">{{BUTTON_EDIT_PROFILE}}</title>
            </svg>
        </div> -->
    </div>
</div>

<!-- FOOTER -->
<div id="chat21-footer" (click)="hideMenuOptions()">
    <div *ngIf="showButtonToBottom" id="chat21-buttonToBottom" (click)="scrollToBottom()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M24 24H0V0h24v24z"/><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6-1.41-1.41z"/></svg>
        <div *ngIf="NUM_BADGES!=0" id="chat21-divBudge" class="c21-divBudge">{{NUM_BADGES}}</div>
    </div>

    <div class="visible-text-area" [class.active]="!isFilePendingToUpload">
        <textarea 
            start-focus-chat21-conversation-component
            inputTextArea 
            #textbox 
            tabindex="1501" 
            aria-labelledby="altTextArea"
            rows="1" 
            id="chat21-main-message-context" 
            class='f21textarea c21-button-clean'
            [(ngModel)]="textInputTextArea"
            (ngModelChange)="resizeInputField()" 
            (keypress)="onkeypress($event)" 
            placeholder="{{g.LABEL_PLACEHOLDER}}">
        </textarea>

    </div>

    <label tabindex="1502" aria-label="allegati" for="chat21-file" class="chat21-textarea-button" [class.active]="!isFilePendingToUpload" id="chat21-start-upload-doc">
        <span class="v-align-center">
            <svg xmlns="http://www.w3.org/2000/svg" [ngStyle]="{'fill': g.themeColor}" width="24" height="24" viewBox="0 0 28 28">
                <!-- <path [ngStyle]="{'fill': g.themeColor}" d="M0 0h24v24H0V0z"/> -->
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
            </svg>
        </span>
        <input tabindex="1503" type="file" aria-label="seleziona allegato" accept="image/*,.pdf,.zip" name="chat21-file"
        id="chat21-file" class="inputfile" 
        [ngStyle]="{'display': 'block', height:'1px', width:'1px', overflow: 'hidden' }"
        (change)="detectFiles($event)" 
        />
    </label>
    <!-- <div [class.active]="isFileSelected" class="chat21-textarea-button" id="chat21-button-reset" (click)="resetLoadImage()"></div> -->
    <div tabindex="-1" class="chat21-textarea-button" [class.active]="!isFilePendingToUpload" [class.active]="textInputTextArea" id="chat21-button-send" (click)="onSendPressed($event)">
        <span class="v-align-center">
            <svg xmlns="http://www.w3.org/2000/svg" [ngStyle]="{'fill': g.themeColor}" width="24" height="24" viewBox="0 0 28 28">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
        </span>
    </div>

    
    <!-- <div [class.active]="isFileSelected" class="name-image" id="chat21-file-selected">
        <span>{{nameFile}}</span>
    </div> -->
    <span id="testFocus" tabindex="1599" onFocus="document.querySelector('[start-focus-chat21-conversation-component]').focus()"></span>
    <span id="altTextArea" style="display: none">scrivi la tua domanda</span>

</div>

<!-- 
<div *ngIf="isFileSelected" class="modal-page" [class.active]="true">
    <tiledeskwidget-preview-loading-files
        [arrayFilesLoad]="arrayFilesLoad"
        (eventClose)="returnClose()" 
        (eventSend)="returnSend()">
    </tiledeskwidget-preview-loading-files>
</div> 
-->